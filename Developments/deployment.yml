name: Deploy to AWS Fargate

on:
  push:
    branches: [ dev ]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 640168418062.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: consuelo/dev/backend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  validate:
    name: ðŸ” Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Check Python syntax
        run: |
          python -m py_compile $(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./data_migrations/*")
      - name: Validate Python syntax and AST
        run: |
          python -c "
          import sys
          import ast
          from pathlib import Path
          
          errors = []
          checked = 0
          
          for py_file in Path('.').rglob('*.py'):
              if 'venv' in str(py_file) or '.venv' in str(py_file) or 'data_migrations' in str(py_file):
                  continue
              
              try:
                  with open(py_file, 'r', encoding='utf-8') as f:
                      source_code = f.read()
                      # Parse AST without executing code
                      ast.parse(source_code, filename=str(py_file))
                  checked += 1
              except SyntaxError as e:
                  errors.append(f'{py_file}:{e.lineno}:{e.offset}: {e.msg}')
              except Exception as e:
                  errors.append(f'{py_file}: {e}')
          
          print(f'Checked {checked} Python files')
          
          if errors:
              print('âŒ Syntax/AST errors found:\\n')
              for error in errors:
                  print(f'  {error}')
              sys.exit(1)
          else:
              print('âœ… All Python files have valid syntax')
          "
      - name: Run linting (if configured)
        continue-on-error: true
        run: |
          if command -v flake8 &> /dev/null || pip list | grep -q flake8; then
            pip install flake8 2>/dev/null || true
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,.venv,data_migrations || true
          fi
  build_and_push:
    name: ðŸ—ï¸ Build & ðŸ“¦ Push to ECR
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $ECR_REGISTRY
      - name: Build image
        run: |
          docker build -t $ECR_REPOSITORY:${IMAGE_TAG} .
      - name: Tag & push to ECR
        run: |
          docker tag $ECR_REPOSITORY:${IMAGE_TAG} $ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_TAG}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_TAG}
  register:
    name: ðŸ§© Register ECS Task Definition
    runs-on: ubuntu-latest
    needs: build_and_push
    outputs:
      task_def_arn: ${{ steps.register.outputs.task_def_arn }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Register new task definition revision
        id: register
        env:
          ECR_IMAGE: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          TASK_FAMILY: DevBackendStackAppTaskDef1EDB5CA8
        run: |
          aws ecs describe-task-definition --task-definition "$TASK_FAMILY" > task-def.json
          NEW_TASK_DEF=$(jq \
            --arg IMAGE "$ECR_IMAGE" \
            '.taskDefinition
            | .containerDefinitions[0].image=$IMAGE
            | del(
                .taskDefinitionArn,
                .revision,
                .status,
                .requiresAttributes,
                .compatibilities,
                .registeredAt,
                .registeredBy,
                .deregisteredAt
              )' task-def.json)
          echo "$NEW_TASK_DEF" > new-task-def.json
          aws ecs register-task-definition --cli-input-json file://new-task-def.json > new-task-def-output.json
          echo "task_def_arn=$(jq -r '.taskDefinition.taskDefinitionArn' new-task-def-output.json)" >> "$GITHUB_OUTPUT"
  deploy:
    name: ðŸš€ Deploy to ECS Service
    runs-on: ubuntu-latest
    needs: register
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster Dev-BackendStack-AppCluster99B78AC1-0rEkMm3mYopQ \
            --service Dev-BackendStack-AppService606B9134-Is8H5qz6PHVw \
            --task-definition "${{ needs.register.outputs.task_def_arn }}" \
            --force-new-deployment
  verify:
    name: âœ… Verify ECS Stability
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
# TODO: delete hardcoded cluster and service names
      - name: Wait for ECS service to become stable
        run: |
          aws ecs wait services-stable \
            --cluster Dev-BackendStack-AppCluster99B78AC1-0rEkMm3mYopQ \
            --services Dev-BackendStack-AppService606B9134-Is8H5qz6PHVw